{{/*
  Purpose: render a small, recursive content tree for site map / menus / section lists.

  Example calls:
    - site map from home
	{{ partial "content-tree.html" . }}
    - section menu in a section template
	{{ partial "content-tree.html" . }}
	- By giving parameters (**all the parameter should be provided**) :
    {{ partial "content-tree.html" (dict
      "context" (.Site.GetPage "/") 
      "currentPage" .
      "sortBy" "Weight"
      "order" "desc"
      "depth" 0
      "debug" true
    ) }}
*/}}

{{ define "subpages" }}

{{ $currentPage := .currentPage }}
{{ $cfg := .cfg }}
{{ $depth := .depth }}

{{ with .context.Pages }}{{/* pour ne pas avoir de <ul> vides */}}
<ul>
	{{ range sort . $cfg.sortBy $cfg.order }}
	<li{{ with .Draft }} class="menu_draft"{{ end }}>
		{{ if $cfg.debug }}{{ .Weight }} - {{ end }}
		{{ if (eq $currentPage .) }}
		<span aria-current="page" class="active">{{ .LinkTitle }}</span>
		{{ else }}
		<a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a>
		{{ end }}
          {{/* recurse if unlimited (0) or depth > 1 */}}
          {{ if or (eq $depth 0) (gt $depth 1) }}
            {{ $nextDepth := 0 }}
            {{ if ne $depth 0 }} {{ $nextDepth = sub $depth 1 }} {{ end }}
            {{ template "subpages" (dict "context" . "currentPage" $currentPage "cfg" $cfg "depth" $nextDepth) }}
          {{ end }}
	</li>
	{{ end }}
</ul>
	{{ end }}
{{ end }}

{{/* minimal: support calling with a full dict OR with . as Page */}}
{{ $context := "" }}
{{ $currentPage := "" }}
{{ $cfg := dict }}
{{ if not .Site }} 
  {{/* dot is a dict with all options */}}
  {{ $context = .context }}
  {{ $currentPage = .currentPage }}
  {{ $cfg = . }}
{{ else }}
  {{ $context = .CurrentSection }}
  {{ if not $context }} {{ $context = .Site.GetPage "/" }} {{ end }}
  {{ $cfg = .Site.Params.contentTree | default (dict "sortBy" "LinkTitle" "order" "asc" "debug" false "depth" 0) }}
{{ end }}

{{/* now invoke recursion with cfg.depth taken from merged cfg */}}
{{ template "subpages" (dict
	"context" $context
	"currentPage" $currentPage
	"cfg" $cfg
	"depth" (index $cfg "depth")
) }}
