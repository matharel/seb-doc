{{- /*
respimg/output.html
Reads values from store and renders final markup.
Usage: partial "respimg/output.html" (dict "store" $store "alt" $alt "class" $class "sizes" $sizes)
*/ -}}

{{- $store := .store -}}
{{- $alt := .alt -}}
{{- $class := .class -}}
{{- $sizes := .sizes -}}

{{- $srcset := $store.Get "srcset" -}}
{{- $srcsetWebp := $store.Get "srcsetWebp" -}}
{{- $defaultRel := $store.Get "defaultRel" -}}
{{- $defaultW := $store.Get "defaultW" -}}
{{- $defaultH := $store.Get "defaultH" -}}
{{- $lqip := $store.Get "lqipDataURI" -}}

<div class="respimg-wrapper {{ $class }}"
     data-respimg-srcset="{{ $srcset | safeHTMLAttr }}"
     data-respimg-default-width="{{ $defaultW }}"
     data-respimg-default-height="{{ $defaultH }}">
  <img class="respimg-lqip" src="{{ $lqip }}" alt="" aria-hidden="true" />

  <picture>
    {{- if and $srcsetWebp (ne $srcsetWebp "") -}}
      <source type="image/webp" srcset="{{ $srcsetWebp }}" sizes="{{ $sizes }}">
    {{- end -}}
    <source srcset="{{ $srcset }}" sizes="{{ $sizes }}">
    <img src="{{ $defaultRel }}" alt="{{ $alt | safeHTMLAttr }}" loading="lazy" decoding="async" width="{{ $defaultW }}" height="{{ $defaultH }}" class="respimg">
  </picture>
</div>

{{- /* optional debug script injection (only when debug=js) */ -}}
{{- $dbg := or .Site.Params.respimg.debug "off" -}}
{{- if eq $dbg "js" -}}
<script>
(function(){
  function updateDebug(el){
    try{
      var rect = el.getBoundingClientRect();
      var img = el.querySelector('img.respimg');
      var displayed = img ? Math.round(img.getBoundingClientRect().width) : null;
      el.dataset.containerWidth = Math.round(rect.width);
      if(displayed!==null) el.dataset.displayedWidth = displayed;
    }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', function(){ document.querySelectorAll('.respimg-wrapper').forEach(updateDebug); });
  window.addEventListener('resize', function(){ document.querySelectorAll('.respimg-wrapper').forEach(updateDebug); });
})();
</script>
{{- end -}}

