{{- /*
respimg/convert.html
Produces:
  - store.Set "srcset"  (string)
  - store.Set "srcsetWebp" (string)  (may be empty)
  - store.Set "defaultRel" (string)
  - store.Set "defaultW" (int)
  - store.Set "defaultH" (int)
  - store.Set "lqipDataURI" (string)
Usage:
  partial "respimg/convert.html" (dict "res" $res "store" $store)
*/ -}}

{{- $res := .res -}}
{{- $store := .store -}}
{{- if not $res -}} {{- return -}} {{- end -}}

{{- /* config */ -}}
{{- $widthsCfg := or .Site.Params.respimg.widths "480,800,1280,1920" -}}
{{- $quality := or .Site.Params.respimg.quality 75 -}}
{{- $lqipSize := or .Site.Params.respimg.lqipSize "20x" -}}
{{- $enableWebp := or .Site.Params.respimg.enableWebp false -}}

{{- /* parse widths */ -}}
{{- $widths := slice -}}
{{- range (split $widthsCfg ",") -}}
  {{- $w := int (trim . " ") -}}
  {{- if gt $w 0 -}} {{- $widths = $widths | append $w -}} {{- end -}}
{{- end -}}
{{- if eq (len $widths) 0 -}} {{- $widths = (slice 480 800 1280 1920) -}} {{- end -}}

{{- $srcsetList := slice -}}
{{- $srcsetWebpList := slice -}}

{{- range $widths -}}
  {{- $w := . -}}
  {{- /* produce canonical resized image */ -}}
  {{- $im := $res.Resize (printf "%dx q%d" $w $quality) -}}
  {{- if $im -}}
    {{- $srcsetList = $srcsetList | append (printf "%s %dw" $im.RelPermalink $w) -}}
    {{- /* webp via Resize spec if enabled */ -}}
    {{- if $enableWebp -}}
      {{- $imw := $res.Resize (printf "%dx webp q%d" $w $quality) -}}
      {{- if $imw -}} {{- $srcsetWebpList = $srcsetWebpList | append (printf "%s %dw" $imw.RelPermalink $w) -}} {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $srcset := delimit $srcsetList ", " -}}
{{- $srcsetWebp := delimit $srcsetWebpList ", " -}}

{{- /* default image: pick middle width */ -}}
{{- $mid := div (len $widths) 2 -}}
{{- if ge $mid (len $widths) -}} {{- $mid = (sub (len $widths) 1) -}} {{- end -}}
{{- $defaultW := index $widths $mid -}}
{{- $defaultImg := $res.Resize (printf "%dx q%d" $defaultW $quality) -}}

{{- /* LQIP tiny base64 */ -}}
{{- $tiny := $res.Resize $lqipSize -}}
{{- $tinyData := $tiny.Content | base64Encode -}}
{{- $mime := printf "image/%s" (or $tiny.MediaType.SubType "jpeg") -}}
{{- $dataURI := printf "data:%s;base64,%s" $mime $tinyData -}}

{{- /* write to store */ -}}
{{- $store.Set "srcset" $srcset -}}
{{- $store.Set "srcsetWebp" $srcsetWebp -}}
{{- $store.Set "defaultRel" $defaultImg.RelPermalink -}}
{{- $store.Set "defaultW" $defaultImg.Width -}}
{{- $store.Set "defaultH" $defaultImg.Height -}}
{{- $store.Set "lqipDataURI" $dataURI -}}

