{{- /*
  layouts/partials/lazyimg.html
  JS-free responsive images with LQIP (tiny inline base64).
  Usage: {{ partial "lazyimg" (dict "img" . "alt" $.Text "class" "optional-class" "sizes" "optional sizes") }}
*/ -}}

{{- $p := . -}}
{{- $imgParam := $p.img -}}
{{- $alt := (or $p.alt "") | safeHTMLAttr -}}
{{- $class := or $p.class "" -}}
{{- $sizesAttr := or (or $p.sizes .Site.Params.lazyimg.sizes) "100vw" -}}
{{- $widthsCfg := or .Site.Params.lazyimg.widths "480,800,1280,1920" -}}
{{- $lqipSize := or .Site.Params.lazyimg.lqipSize "20x" -}}

{{- /* parse widths */ -}}
{{- $widths := slice -}}
{{- range (split $widthsCfg ",") -}}
  {{- $w := int (trim . " ") -}}
  {{- if gt $w 0 -}} {{- $widths = $widths | append $w -}} {{- end -}}
{{- end -}}
{{- if eq (len $widths) 0 -}} {{- $widths = (slice 480 800 1280 1920) -}} {{- end -}}

{{- /* resolve resource: prefer page bundle resource */ -}}
{{- $res := .Page.Resources.GetMatch (printf "%v" $imgParam) -}}
{{- if not $res -}}
  {{- if and (isset $imgParam "RelPermalink") (isset $imgParam "MediaType") -}}
    {{- $res = $imgParam -}}
  {{- end -}}
{{- end -}}
{{- if not $res -}}
  {{- $res = resources.Get (printf "%v" $imgParam) -}}
{{- end -}}

{{- if not $res -}}
  {{- /* final fallback: plain <img> */ -}}
  <img src="{{ (printf "%v" $imgParam) | safeURL }}" alt="{{ $alt }}" loading="lazy" decoding="async" class="{{ $class }}">
  {{- return -}}
{{- end -}}

{{- $ext := lower (path.Ext $res.Name) -}}
{{- if in (slice ".svg" ".gif") $ext -}}
  <img src="{{ $res.RelPermalink }}" alt="{{ $alt }}" loading="lazy" decoding="async" class="{{ $class }}" width="{{ $res.Width }}" height="{{ $res.Height }}">
  {{- return -}}
{{- end -}}

{{- /* build srcsets */ -}}
{{- $srcset := slice -}}
{{- $srcsetWebp := slice -}}
{{- range $widths -}}
  {{- $w := . -}}
  {{- $im := $res.Resize (printf "%dx q75" $w) -}}
  {{- if $im -}}
    {{- $srcset = $srcset | append (printf "%s %dw" $im.RelPermalink $w) -}}
    {{- $imWebp := ($im).Convert "webp" -}}
    {{- if $imWebp -}} {{- $srcsetWebp = $srcsetWebp | append (printf "%s %dw" $imWebp.RelPermalink $w) -}} {{- end -}}
  {{- end -}}
{{- end -}}
{{- $srcsetStr := delimit $srcset ", " -}}
{{- $srcsetWebpStr := delimit $srcsetWebp ", " -}}

{{- /* default (middle) image */ -}}
{{- $midIdx := div (len $widths) 2 -}}
{{- if ge $midIdx (len $widths) -}} {{- $midIdx = (sub (len $widths) 1) -}} {{- end -}}
{{- $defaultW := index $widths $midIdx -}}
{{- $defaultImg := $res.Resize (printf "%dx q75" $defaultW) -}}

{{- /* LQIP tiny base64 */ -}}
{{- $tiny := $res.Resize $lqipSize -}}
{{- $tinyData := $tiny.Content | base64Encode -}}
{{- $mime := printf "image/%s" (or $tiny.MediaType.SubType "jpeg") -}}
{{- $dataURI := printf "data:%s;base64,%s" $mime $tinyData -}}

{{/* Output structure: LQIP img placed before the picture; CSS will cover layout and blur */}}
<div class="lazyimg-wrapper {{ $class }}">
  <img class="lazyimg-lqip" src="{{ $dataURI }}" alt="" aria-hidden="true" />
  <picture>
    {{- if ne $srcsetWebpStr "" -}}
      <source type="image/webp" srcset="{{ $srcsetWebpStr }}" sizes="{{ $sizesAttr }}">
    {{- end -}}
    <source srcset="{{ $srcsetStr }}" sizes="{{ $sizesAttr }}">
    <img src="{{ $defaultImg.RelPermalink }}" alt="{{ $alt }}" loading="lazy" decoding="async" width="{{ $defaultImg.Width }}" height="{{ $defaultImg.Height }}" class="lazyimg">
  </picture>
</div>

